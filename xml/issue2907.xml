<?xml version='1.0' encoding='utf-8' standalone='no'?>
<!DOCTYPE issue SYSTEM "lwg-issue.dtd">

<issue num="2907" status="New">
<title>semantics for destroying the deleter and the control-block of a shared_ptr are unclear</title>
<section><sref ref="[util.smartptr.shared.dest]"/></section>
<submitter>United States</submitter>
<date>3 Feb 2017</date>
<priority>99</priority>

<discussion>
<b>Addresses US 134</b>

<p>The semantics for destroying the deleter and the control-block are unclear. In particular, it is not clear that we guarantee a lack of race conditions destroying the control-block and deleter. Possible race-free implementations might destroy the deleter after running d(p), and before giving up the weak reference held by this shared_ptr; running the destructor for 'd' only when the last weak_ptr is destroyed, potentially at a much later date, but ensuring that d(p) completes before the shared_ptr gives up its weak reference; making a copy of 'd' in the destructor before manipulating the weak count, and then using this copy to run 'd(p)', even while the control-block could be concurrently reclaimed with an expiring weak_ptr in another thread. Note that this may be related to LWG #2751. (Also, see the note in 20.11.2.2.10p1 [util.smartptr.getdeleter])</p>

<p>Proposed change: Clarify that the shared_ptr weak ownership of the control block is released at the end of the destructor, and not as the destructor begins. Otherwise, the deleter might be destroyed even before the destructor gets to move a copy to call safely.</p>

</discussion>

<resolution>
<p>
</p>
</resolution>

</issue>
