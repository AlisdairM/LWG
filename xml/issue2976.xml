<?xml version='1.0' encoding='utf-8' standalone='no'?>
<!DOCTYPE issue SYSTEM "lwg-issue.dtd">

<issue num="2976" status="Open">
<title>Dangling <tt>uses_allocator</tt> specialization for <tt>packaged_task</tt></title>
<section><sref ref="[futures.task]"/><sref ref="[future.syn]"/><sref ref="[futures.task.nonmembers]"/></section>
<submitter>Tim Song</submitter>
<date>13 Jun 2017</date>
<priority>3</priority>

<discussion>
<p>
When LWG <iref ref="2921"/> removed allocator support from <tt>packaged_task</tt>, it forgot
to remove the <tt>uses_allocator</tt> partial specialization.
</p>

<note>
2017-07-26 Moved to Tentatively Ready after 6 positive votes on c++std-lib.
</note>

<note>2017-07-26, Billy O'Neal reopens</note>
<p>
I think <iref ref="2921"/> was resolved in error. If <tt>promise&lt;T&gt;</tt> can have an allocator, there's no 
reason for <tt>packaged_task&lt;T&gt;</tt> to not have one. If we remove it from <tt>packaged_task</tt> we should 
remove it from <tt>promise</tt> as well.
<p/>
Note that I am not objecting to removing allocator support here, I'm objecting to the "remove it because this looks 
like <tt>std::function</tt>" case. <tt>packaged_task</tt> has none of the <tt>std::function</tt> problems because 
the function inside a given <tt>packaged_task</tt> is not reassignable.
<p/>
If LWG decides to remove allocator support here then there are more bits that need to be struck, e.g. 
<a href="http://eel.is/c++draft/futures#task.members-5.3">[futures.task.members] (5.3)</a>.
</p>
</discussion>

<resolution>
<p>This wording is relative to <a href="http://wg21.link/n4659">N4659</a>.</p>

<ol>
<li>
<p>Modify <sref ref="[future.syn]"/>, header <tt>&lt;future&gt;</tt> synopsis, and
<sref ref="[futures.task]"/>, class template <tt>packaged_task</tt> synopsis, as indicated:</p>

<blockquote>
<pre>
<del>template &lt;class R, class Alloc&gt;
struct uses_allocator&lt;packaged_task&lt;R&gt;, Alloc&gt;;</del>
</pre>
</blockquote>
</li>

<li>
<p>Modify <sref ref="[futures.task.nonmembers]"/> as indicated:</p>

<blockquote>
<pre>
<del>template &lt;class R, class Alloc&gt;
  struct uses_allocator&lt;packaged_task&lt;R&gt;, Alloc&gt;
    : true_type { };</del>
</pre>
<blockquote>
<p>
<del>-2- <i>Requires:</i> <tt>Alloc</tt> shall be an Allocator (20.5.3.5).</del>
</p>
</blockquote>
</blockquote>
</li>
</ol>

</resolution>

</issue>
